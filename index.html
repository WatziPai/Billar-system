<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n de Billar</title>
    <!-- Asumo que styles.css y los archivos JS existen en el entorno -->
    <link rel="stylesheet" href="styles.css"> 
</head>
<body>
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="login-icon">üé±</div>
            <h1>Sistema de Billar</h1>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">Inicia sesi√≥n para continuar</p>
            
            <div id="loginError" class="error-msg hidden"></div>
            
            <div class="input-group">
                <label>Usuario</label>
                <input type="text" id="loginUsername" placeholder="Ingresa tu usuario" autocomplete="username">
            </div>
            
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="Ingresa tu contrase√±a" autocomplete="current-password">
            </div>
            
            <button class="btn btn-primary" style="width: 100%;" id="btnLogin" onclick="handleLogin()">
                Iniciar Sesi√≥n
            </button>
        </div>
    </div>

    <div id="mainScreen" class="container hidden">
        <div class="header">
            <div class="header-top">
                <div>
                    <h1>üé± Sistema de Gesti√≥n de Billar</h1>
                    <div class="user-info">
                        Bienvenido, <strong id="userName"></strong>
                        <span class="user-badge" id="userRole"></span>
                        <span style="margin-left: 10px; color: #28a745; font-size: 12px;">‚óè Conectado</span>
                    </div>
                </div>
                <div class="header-buttons">
                    <button id="btnUsuarios" class="btn-small btn-blue hidden" onclick="toggleUsuarios()">
                        üë• Usuarios
                    </button>
                    <button class="btn-small btn-red" onclick="handleLogout()">
                        üö™ Salir
                    </button>
                </div>
            </div>

            <div id="usuariosPanel" class="usuarios-panel hidden">
                <div class="section-header">
                    <h3>Gesti√≥n de Usuarios</h3>
                    <button class="btn-small btn-green" onclick="showModalUsuario()">
                        ‚ûï Crear Usuario
                    </button>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Nombre</th>
                                <th>Rol</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usuariosTable"></tbody>
                    </table>
                </div>
            </div>

            <div class="config-grid">
                <div class="config-box" style="background: #cfe2ff;">
                    <label>Tarifa por Hora Completa (S/)</label>
                    <input type="number" id="tarifaHora" value="5.00" step="0.50" min="0">
                </div>
                <div class="config-box" style="background: #fff3cd;">
                    <label for="tarifaExtra5Min">Tarifa cada 10 min extra (S/)</label>
                    <input type="number" id="tarifaExtra5Min" step="0.01" min="0" value="1.00">
                </div>
                <div class="config-box" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-blue" onclick="guardarConfiguracion()" style="width: 100%; padding: 10px;">
                        üíæ Guardar Configuraci√≥n
                    </button>
                </div>
                <div class="config-box total-box">
                    <label>Total del D√≠a</label>
                    <div class="total-amount" id="totalDia">S/ 0.00</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="changeTab('mesas', event)" data-tab="mesas">
                üé± Mesas
            </button>
            <button class="tab" onclick="changeTab('ventas', event)" data-tab="ventas">
                üí∞ Ventas
            </button>
            <button class="tab" onclick="changeTab('inventario', event)" data-tab="inventario">
                üì¶ Inventario
            </button>
            <button class="tab" onclick="changeTab('reportes', event)" data-tab="reportes">
                üìä Reportes
            </button>
            <button id="tabErrores" class="tab hidden" onclick="changeTab('errores', event)" data-tab="errores">
                ‚ö†Ô∏è Errores
            </button>
            <button id="tabConsumoDueno" class="tab hidden" onclick="changeTab('consumoDueno', event)" data-tab="consumoDueno">
                üçΩÔ∏è Consumo Due√±o
            </button>
        </div>

        <div id="tabMesas" class="tab-content active">
            <div class="section-box" style="margin-bottom: 30px;">
                <div class="section-header">
                    <h2>üé± Mesas de Billar</h2>
                    <button id="btnAgregarMesa" class="btn-small btn-green hidden" onclick="agregarMesa()">
                        ‚ûï Agregar Mesa
                    </button>
                </div>
                <div id="mesasContainer" class="mesas-grid"></div>
            </div>

            <div class="section-divider">
                <span>üç∫ ZONA DE CONSUMO</span>
            </div>
            
            <div class="section-box">
                <div class="section-header">
                    <h2>üç∫ Mesas de Consumo (Tomar/Fumar)</h2>
                    <button id="btnAgregarMesaConsumo" class="btn-small btn-green hidden" onclick="agregarMesaConsumo()">
                        ‚ûï Agregar Mesa
                    </button>
                </div>
                <div id="mesasConsumoContainer" class="mesas-grid"></div>
            </div>
        </div>

        <div id="tabVentas" class="tab-content">
            <div class="ventas-section">
                <div class="section-header">
                    <h2>Registro de Ventas</h2>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-small btn-blue" onclick="showModalVentaManual()">
                            ‚ûï Venta Manual
                        </button>
                        <button class="btn-small btn-green" onclick="showModalVentaProductos()">
                            üõí Vender Productos
                        </button>
                        <button id="btnReportarError" class="btn-small btn-orange hidden" onclick="showModalError()">
                            ‚ö†Ô∏è Reportar Error
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Descripci√≥n</th>
                                <th>Usuario</th>
                                <th style="text-align: right;">Monto</th>
                                <th style="text-align: center;">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="ventasTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tabInventario" class="tab-content">
            <div class="section-box">
                <div class="section-header">
                    <h2>Inventario de Productos</h2>
                    <button id="btnAgregarProducto" class="btn-small btn-green hidden" onclick="showModalProducto()">
                        ‚ûï Agregar Producto
                    </button>
                </div>
                <div id="inventarioGrid" class="inventario-grid"></div>
            </div>
        </div>

        <div id="tabReportes" class="tab-content">
            <div class="section-box">
                <h2 style="margin-bottom: 20px;">Reportes y Estad√≠sticas</h2>
                
                <div class="reporte-grid">
                    <div class="reporte-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h3>Total Ventas</h3>
                        <div class="valor" id="reporteTotalVentas">S/ 0.00</div>
                    </div>
                    <div class="reporte-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h3>Ventas Mesas</h3>
                        <div class="valor" id="reporteVentasMesas">S/ 0.00</div>
                    </div>
                    <div class="reporte-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h3>Ventas Productos</h3>
                        <div class="valor" id="reporteVentasProductos">S/ 0.00</div>
                    </div>
                    <div class="reporte-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h3>Transacciones</h3>
                        <div class="valor" id="reporteTransacciones">0</div>
                    </div>
                    <div class="reporte-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <h3>Consumo Due√±o</h3>
                        <div class="valor" id="reporteConsumoDueno" style="font-size: 14px;">S/ 0.00</div>
                    </div>
                </div>

                <div style="margin: 20px 0; text-align: center;">
                    <button class="btn btn-primary" onclick="cerrarDia()" style="padding: 15px 40px; font-size: 16px;">
                        üîí Cerrar Turno/D√≠a
                    </button>
                    <p style="margin-top: 10px; color: #666; font-size: 13px;">
                        Genera un reporte del per√≠odo actual y archiva las ventas
                    </p>
                </div>

                <h3 style="margin: 30px 0 15px 0;">Detalle de Ventas</h3>
                
                <div class="table-responsive">
                    <div id="reporteDetalleContainer">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Descripci√≥n</th>
                                    <th>Usuario</th>
                                    <th style="text-align: right;">Monto</th>
                                </tr>
                            </thead>
                            <tbody id="reporteDetalleTable"></tbody>
                        </table>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="color: #2d7a4d; margin-bottom: 15px;">üìÅ Historial de Cierres</h3>
                    <div id="historialCierresContainer"></div>
                </div>
            </div>
        </div>

        <div id="tabErrores" class="tab-content">
            <div class="section-box">
                <div class="section-header">
                    <h2>Errores Reportados</h2>
                </div>
                <div id="erroresContainer"></div>
            </div>
        </div>

       <div id="consumoDuenoTab" class="tab-content">  <!-- Cambiar de tabConsumoDueno a consumoDuenoTab -->
        <div class="section-box">
            <div class="section-header">
                <h2>üçΩÔ∏è Consumo del Due√±o</h2>
                <button class="btn-small btn-primary" onclick="showModalConsumoDueno()">
                    ‚ûï Registrar Consumo
                </button>
            </div>
            <p style="color: #666; margin-bottom: 20px;">
                ‚ÑπÔ∏è Aqu√≠ se registran los consumos personales que NO se cobran, pero se descuentan del stock
            </p>
            <div id="consumoDuenoContainer" style="display: block !important;"></div>
        </div>
    </div>
    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <p style="margin-top: 20px; color: white;">Cargando...</p>
    </div>

    <!-- MODALES -->
    <div id="modalUsuario" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="usuarioModalTitle">Crear Usuario</div>
            <div id="usuarioError" class="error-msg hidden"></div>
            <div class="input-group">
                <label>Nombre Completo</label>
                <input type="text" id="nuevoNombre" autocomplete="name">
            </div>
            <div class="input-group">
                <label>Usuario</label>
                <input type="text" id="nuevoUsername" autocomplete="username">
            </div>
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="nuevoPassword" autocomplete="new-password" placeholder="Dejar en blanco para mantener la actual (al editar)">
            </div>
            <div class="input-group">
                <label>Rol</label>
                <select id="nuevoRol">
                    <option value="empleado">Empleado</option>
                    <option value="admin">Administrador</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-green btn-full" onclick="guardarUsuario()">Guardar</button>
                <button class="btn btn-gray btn-full" onclick="closeModalUsuario()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Venta de Tiempo/Consumo de Mesa (Faltante) -->
    <div id="modalConsumo" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;" id="consumoModalTitle">Consumo - Mesa XX</h2>
                <button class="close-btn" onclick="closeModalConsumo()">√ó</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <!-- Productos disponibles -->
                <div>
                    <h3 style="margin: 0 0 15px 0;">Productos Disponibles</h3>
                    <div id="productosConsumoGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto;">
                        <!-- Productos se renderizar√°n aqu√≠ -->
                    </div>
                </div>
                
                <!-- Lista de Consumos de la Mesa -->
                <div style="background: #e9f0f9; padding: 15px; border-radius: 8px;">
                    <h3 style="margin: 0 0 15px 0;">üç∫ Consumos de la Mesa</h3>
                    <div id="listaConsumos" style="margin-bottom: 20px; max-height: 350px; overflow-y: auto;">
                        <!-- Consumos de la mesa (producto, cantidad, eliminar) se renderizar√°n aqu√≠ -->
                    </div>
                    <div style="border-top: 2px solid #b3cde3; padding-top: 15px; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <strong style="font-size: 18px;">Total Consumo:</strong>
                            <strong id="totalConsumo" style="font-size: 24px; color: #007bff;">S/ 0.00</strong>
                        </div>
                        <button id="btnCerrarMesa" class="btn btn-blue" onclick="cerrarMesaCompleto()" style="width: 100%; padding: 12px;">
                            üíµ Cerrar Mesa y Cobrar (Total: S/ 0.00)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Fin Modal Consumo Faltante -->


    <div id="modalVentaManual" class="modal">
        <div class="modal-content">
            <div class="modal-header">Venta Manual</div>
            <div class="input-group">
                <label>Descripci√≥n</label>
                <input type="text" id="ventaDescripcionManual" placeholder="Ej: Alquiler mesa pool">
            </div>
            <div class="input-group">
                <label>Monto (S/)</label>
                <input type="number" id="ventaMontoManual" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-green btn-full" onclick="agregarVentaManual()" id="btnGuardarVentaManual">
                    Guardar
                </button>
                <button class="btn btn-gray btn-full" onclick="closeModalVentaManual()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalVentaProductos" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">Vender Productos</div>
            <div id="productosVentaContainer" class="productos-venta-grid"></div>
            <div class="modal-buttons">
                <button class="btn btn-gray btn-full" onclick="closeModalVentaProductos()">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="productoModalTitle">Agregar Producto</div>
            <div id="productoError" class="error-msg hidden"></div>
            <div class="input-group">
                <label>Nombre</label>
                <input type="text" id="productoNombre" placeholder="Ej: Cerveza Pilsen">
            </div>
            <div class="input-group">
                <label>Precio (S/)</label>
                <input type="number" id="productoPrecio" step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="input-group">
                <label>Stock Inicial</label>
                <input type="number" id="productoStock" min="0" placeholder="0">
            </div>
            <div class="input-group">
                <label>Stock M√≠nimo (Alerta)</label>
                <input type="number" id="productoStockMin" min="0" value="5" placeholder="5">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-green btn-full" onclick="guardarProducto()">Guardar</button>
                <button class="btn btn-gray btn-full" onclick="closeModalProducto()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalStock" class="modal">
        <div class="modal-content">
            <div class="modal-header">Ajustar Stock</div>
            <h3 id="stockProductoNombre" style="margin-bottom: 15px; color: #666;"></h3>
            <div class="input-group">
                <label>Stock Actual: <strong id="stockActual">0</strong></label>
            </div>
            <div class="input-group">
                <label>Ajuste (+/-)</label>
                <input type="number" id="stockAjuste" placeholder="+10 para agregar, -5 para quitar">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-green btn-full" onclick="ajustarStock()">Guardar</button>
                <button class="btn btn-gray btn-full" onclick="closeModalStock()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modalError" class="modal">
        <div class="modal-content">
            <div class="modal-header">Reportar Error</div>
            <div class="input-group">
                <label>Describe el error</label>
                <textarea id="errorMensaje" placeholder="Describe qu√© sucedi√≥... Ej: La mesa 2 no calcul√≥ bien el tiempo" rows="5"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-orange btn-full" onclick="reportarError()">Enviar</button>
                <button class="btn btn-gray btn-full" onclick="closeModalError()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Consumo Due√±o -->
    <div id="modalConsumoDueno" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üçΩÔ∏è Registrar Consumo del Due√±o</h2>
                <button class="close-btn" onclick="closeModalConsumoDueno()">√ó</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <!-- Productos disponibles -->
                <div>
                    <h3 style="margin: 0 0 15px 0;">Productos Disponibles</h3>
                    <div id="productosConsumoDuenoGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; max-height: 500px; overflow-y: auto;"></div>
                </div>
                
                <!-- Carrito -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h3 style="margin: 0 0 15px 0;">üõí Carrito</h3>
                    <div id="carritoConsumoDuenoContainer" style="margin-bottom: 20px; max-height: 350px; overflow-y: auto;"></div>
                    <div style="border-top: 2px solid #dee2e6; padding-top: 15px; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <strong style="font-size: 18px;">Total:</strong>
                            <strong id="totalConsumoDueno" style="font-size: 24px; color: #ff9800;">S/ 0.00</strong>
                        </div>
                        <button id="btnGuardarConsumoDueno" class="btn btn-primary" onclick="guardarConsumoDueno()" style="width: 100%; padding: 12px;" disabled>
                            üíæ Guardar Consumo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="module" src="firebase-config.js"></script>
    <script src="app.js"></script>
</body>
</html>
